# 第9章　変更に強い運用：影響度評価で手戻りを消す

## この章で学ぶこと

- 変更の種類と影響度の分類
- HIGH変更時の必須チェックリスト
- 仕様変更→AI再実装を安全に繰り返す設計

---

## なぜ影響度評価が必要か

### 変更は避けられない

ソフトウェア開発において、**仕様変更は必ず起きます**。

- ビジネス要件の変更
- ユーザーフィードバックへの対応
- 技術的負債の解消
- セキュリティ対応

問題は変更そのものではなく、**変更の影響が見えないこと** です。

### 見えない影響が手戻りを生む

```
「パスワードを12文字以上に変更」
  ↓
影響を見落とす
  ↓
- フロントのバリデーションが古いまま
- テストケースが更新されていない
- APIドキュメントが古い
- 既存ユーザーへの案内が必要だった
  ↓
本番でバグ発覚、手戻り
```

影響度評価は、**この「見えない影響」を事前に可視化**する仕組みです。

---

## 変更の3分類

![変更影響度評価](../images/ch09-change-impact.jpeg)

すべての変更を以下の3つに分類します。

### LOW：文言修正・スタイル調整

**特徴**：
- 機能的な影響なし
- 他の文書への波及なし
- レビュー1人で十分

**例**：
- エラーメッセージの文言修正
- コメントの追加・修正
- ドキュメントの誤字修正
- コードフォーマットの調整

**対応**：
```markdown
## 変更内容
エラーメッセージを「無効なパスワード」→「パスワードが正しくありません」に変更

## 影響度: LOW
## 対応: 単独で変更可能
```

### MEDIUM：既存概念の拡張

**特徴**：
- 既存の機能に影響する可能性あり
- 関連文書の確認が必要
- レビュー複数人推奨

**例**：
- 新しいフィールドの追加
- オプション機能の追加
- APIにパラメータ追加
- 新しいエラーケースの追加

**対応**：
```markdown
## 変更内容
ユーザーモデルにprofileImageUrlフィールドを追加

## 影響度: MEDIUM

## 確認が必要な文書
- [ ] DOMAIN.md: Userエンティティの定義更新
- [ ] ARCHITECTURE.md: 画像ストレージの設計確認
- [ ] TESTING.md: プロフィール画像関連のテストケース

## 後方互換性
- 既存APIは影響なし（オプショナルフィールド）
- 既存データはnullで初期化
```

#### LOW vs MEDIUMの境界

「これはLOW？それともMEDIUM？」と迷うケースがあります。判断のポイントは、**他の箇所に波及するかどうか** です。

たとえば、エラーメッセージの文言変更は通常LOWです。しかし、そのエラーメッセージをフロントエンドがパースして分岐処理していたらどうでしょう。「無効なパスワード」を「パスワードが正しくありません」に変えると、フロントエンドのコードが壊れます。これはMEDIUMです。

同様に、コメントの追加は通常LOWですが、そのコメントがAPIドキュメントに自動生成される仕組みになっていれば、MEDIUMになる可能性があります。

判断に迷ったときは、**MEDIUMとして扱う** のが安全です。LOWと判断して漏れがあると手戻りが発生しますが、MEDIUMとして扱って実はLOWだったとしても、追加の確認をしただけで済みます。

### HIGH：概念の再定義・削除

**特徴**：
- 根本的な設計変更
- 複数の文書への波及
- 全関連チームのレビュー必須

**例**：
- データモデルの構造変更
- APIの破壊的変更
- 認証方式の変更
- ビジネスルールの根本的変更
- 機能の削除

**対応**：
```markdown
## 変更内容
認証方式をセッションベースからJWTに変更

## 影響度: HIGH

## 必須チェックリスト
- [ ] PROJECT.md: セキュリティ要件との整合性
- [ ] ARCHITECTURE.md: 認証フロー全体の再設計
- [ ] DOMAIN.md: セッション関連ルールの削除/JWT関連ルールの追加
- [ ] PATTERNS.md: 認証関連のコードパターン更新
- [ ] TESTING.md: 認証関連のテストケース全更新
- [ ] DEPLOYMENT.md: セッションストア削除、JWT鍵管理追加

## 移行計画
1. Phase 1: JWT認証を並行稼働（2週間）
2. Phase 2: 新規ログインはJWTのみ（1週間）
3. Phase 3: セッション認証を完全廃止

## ADR（Architecture Decision Record）
- ADR-005: 認証方式の変更.md
```

#### MEDIUM vs HIGHの境界

MEDIUMとHIGHの境界も迷いやすいポイントです。判断基準は、**既存の設計を維持できるかどうか** です。

MEDIUMは「拡張」です。既存の設計の枠内で、新しい要素を追加します。たとえば、ユーザーモデルに新しいフィールドを追加するのはMEDIUMです。既存のコードは影響を受けず、新しいフィールドを使うコードだけが変更されます。

一方、HIGHは「再設計」です。既存の設計を根本から変える必要があります。たとえば、ユーザーIDをUUIDから連番に変更するのはHIGHです。すべての参照箇所、外部キー、API、フロントエンドの表示ロジックまで影響が波及します。

もう一つの判断ポイントは、**ロールバックの難易度** です。MEDIUMの変更は比較的簡単にロールバックできます。追加したフィールドを無視すれば、旧バージョンに戻せます。しかし、HIGHの変更はロールバックが困難です。データ移行が絡む場合、元に戻すにも移行作業が必要になります。

#### 影響度を過小評価したときの教訓

あるプロジェクトで、「ユーザー名のバリデーションルールを変更」という作業が発生しました。担当者は「バリデーションの文字数を変えるだけ」と判断し、LOWとして対応しました。

実際には、以下の影響がありました。

- フロントエンドのフォームバリデーション（別リポジトリ）
- モバイルアプリのバリデーション（別チーム管轄）
- 既存ユーザーのユーザー名が新ルールに違反するケース
- CSVインポート機能のバリデーション
- 管理画面の表示幅

本番デプロイ後、モバイルアプリで登録できないという問い合わせが発生。調査と修正に3日を要しました。最初からMEDIUM以上として扱い、関連チームに確認していれば、1日で完了していたはずです。

この教訓から、「単純に見える変更ほど慎重に」というルールがチームに定着しました。

---

## HIGH変更の必須チェックリスト

HIGH変更を行う際は、以下のチェックリストを必ず実施します。

### 1. 影響範囲の洗い出し

```markdown
## 影響を受ける文書
- [ ] PROJECT.md: [該当セクション]
- [ ] ARCHITECTURE.md: [該当セクション]
- [ ] DOMAIN.md: [該当セクション]
- [ ] PATTERNS.md: [該当セクション]
- [ ] TESTING.md: [該当セクション]
- [ ] DEPLOYMENT.md: [該当セクション]

## 影響を受けるコード
- [ ] [ディレクトリ/ファイル1]
- [ ] [ディレクトリ/ファイル2]

## 影響を受ける外部システム
- [ ] [外部API/サービス]
```

### 2. 後方互換性の確認

```markdown
## 後方互換性
### 維持できる点
- [互換性が保たれる機能]

### 破壊的変更
- [互換性が失われる機能]
- 対応策: [移行方法]
```

### 3. 移行計画

```markdown
## 移行計画
### Phase 1: 準備（〜開始前）
- [ ] 新旧両対応の実装
- [ ] 移行用テストの追加

### Phase 2: 並行稼働
- [ ] 新方式を有効化
- [ ] モニタリング強化

### Phase 3: 旧方式の廃止
- [ ] 旧コードの削除
- [ ] ドキュメントの整理
```

### 4. ロールバック計画

```markdown
## ロールバック計画
### トリガー条件
- エラーレートが5%を超えた場合
- レスポンスタイムがp99で1秒を超えた場合

### ロールバック手順
1. [具体的な手順1]
2. [具体的な手順2]
3. [具体的な手順3]
```

### 5. ADR（Architecture Decision Record）

HIGH変更は、必ず**意思決定の記録** を残します。

```markdown
# ADR-005: 認証方式の変更

## ステータス
承認済み

## コンテキスト
現在のセッションベース認証では、水平スケールが困難。
マイクロサービス化に向けて、ステートレスな認証が必要。

## 決定
JWTベースの認証に移行する。

## 理由
- ステートレスでスケーラブル
- マイクロサービス間での認証が容易
- 業界標準で知見が豊富

## 却下した代替案
### セッション認証の維持
- 理由: スケール時にセッション共有が複雑化

### OAuth2 + OpenID Connect
- 理由: 現時点ではオーバースペック（将来的には検討）

## 結果
- JWT実装により認証サーバーが不要になった
- レスポンスタイムが平均20%改善
- セッションストア（Redis）のコストが削減
```

---

## 仕様変更→AI再実装を安全に繰り返す設計

### 安全な反復のための3原則

#### 原則1：変更は必ず文書から始める

```
❌ 危険なフロー
コード変更 → 後からドキュメント更新

✅ 安全なフロー
ドキュメント変更 → 影響度評価 → コード変更
```

ドキュメントを先に変更することで、**影響範囲を事前に把握** できます。

#### 原則2：影響度に応じたレビュー体制

| 影響度 | レビュー体制 |
|--------|------------|
| LOW | 1人承認でOK |
| MEDIUM | 2人以上、関連チーム1人以上 |
| HIGH | 全関連チーム、テックリード必須 |

#### 原則3：段階的なデプロイ

HIGH変更は一気にデプロイしません。

```
開発環境 → ステージング → カナリア（10%） → 本番（100%）
    ↑          ↑            ↑
  問題検出     問題検出       問題検出
```

各段階で問題が検出されたら、即座にロールバックできる状態を維持します。

### AIへの指示テンプレート

仕様変更後にAIに再実装を依頼する際のテンプレート：

```markdown
## 仕様変更対応の依頼

### 変更内容
[DOMAIN.mdの該当部分を抜粋]

### 影響度
[LOW / MEDIUM / HIGH]

### 変更対象ファイル
- src/services/auth/login.ts
- src/services/auth/__tests__/login.test.ts

### 制約
- 後方互換性を維持すること
- 既存のテストが全てパスすること
- 新しいテストケースを追加すること

### 確認ポイント
- [ ] 変更前の動作を壊していないか
- [ ] 新しい仕様に従っているか
- [ ] テストカバレッジが維持されているか
```

---

## 章末チェックリスト

- [ ] 最近の変更を3分類（LOW/MEDIUM/HIGH）で振り返る
- [ ] HIGH変更のチェックリストをPRテンプレートに追加する
- [ ] ADRを書く習慣をつける（まずは1件から）
- [ ] 「コード先、ドキュメント後」の習慣を「ドキュメント先」に変える

---

## 次章への橋渡し

この章では、影響度評価を使った変更管理を学びました。

次章からは**第4部「現場FAQ」** に入ります。「結局エンジニアが全部書くのでは？」「品質は担保できるのか？」といった現場でよく出る疑問に答えます。
