# 第8章　文書追加の意思決定（Decision Matrix）

## この章で学ぶこと

- 新しい情報をどの文書に置くべきかの判断基準
- 具体的なケーススタディ（DB設計、認証、権限など）
- MASTER.mdの索引更新を習慣化する方法

---

## 「これはどこに書く？」の判断基準

### 問題：情報が散在する

7文書構成を導入しても、こんな迷いが生じます。

- 「認証の仕様って、ARCHITECTURE？DOMAIN？」
- 「このAPIの詳細はどこに書く？」
- 「監査ログの要件は？」

判断基準がないと、人によって置き場所が変わり、結局**情報が散在**します。

### Decision Matrix

![文書選択マトリックス](../images/ch08-decision-matrix.jpeg)

以下のマトリクスで判断します。

| 情報の種類 | 置き場所 | 判断基準 |
|-----------|---------|---------|
| なぜ作るか | PROJECT.md | ビジネス目標、ユーザー価値 |
| 何を作るか | PROJECT.md | 機能一覧、要件定義 |
| どう作るか | ARCHITECTURE.md | 技術選定、システム構成 |
| ルールは何か | DOMAIN.md | ビジネスロジック、制約 |
| どう書くか | PATTERNS.md | コーディング規約、パターン |
| 何が正しいか | TESTING.md | テスト戦略、品質基準 |
| どう運用するか | DEPLOYMENT.md | デプロイ、監視、障害対応 |

### 判断フローチャート

```
新しい情報を追加したい
       │
       ▼
┌─────────────────────────────────┐
│ この情報は「ビジネスの目的・価値」に関するか？ │
└─────────────────────────────────┘
       │Yes              │No
       ▼                 ▼
  PROJECT.md    ┌─────────────────────────┐
                │ 「技術的な設計判断」に関するか？ │
                └─────────────────────────┘
                       │Yes              │No
                       ▼                 ▼
               ARCHITECTURE.md  ┌───────────────────────┐
                                │ 「業務ルール・制約」に関するか？ │
                                └───────────────────────┘
                                       │Yes              │No
                                       ▼                 ▼
                                   DOMAIN.md    ┌─────────────────────┐
                                                │ 「書き方・パターン」に関するか？ │
                                                └─────────────────────┘
                                                       │Yes              │No
                                                       ▼                 ▼
                                                  PATTERNS.md   ┌───────────────────┐
                                                                │ 「テスト・品質」に関するか？ │
                                                                └───────────────────┘
                                                                       │Yes              │No
                                                                       ▼                 ▼
                                                                  TESTING.md    DEPLOYMENT.md
                                                                               （運用・デプロイ）
```

### フローチャートで決まらないとき

このフローチャートは便利ですが、「どちらにも当てはまる」「どれにも当てはまらない」と感じるケースがあります。そのときの対処法を知っておきましょう。

#### どちらにも当てはまる場合

「キャッシュ戦略」を例に考えます。「Redisを使う」は技術判断（ARCHITECTURE）ですが、「キャッシュの有効期限を30分にする」はビジネス要件にも関係します。このような場合は、**情報の性質で分割**します。技術的な「どう実現するか」はARCHITECTURE、ビジネス的な「なぜその値か」はDOMAINに書きます。分割することで、技術変更とビジネス変更を独立して管理できます。

#### どれにも当てはまらない場合

「外部APIのエンドポイント一覧」のような情報は、フローチャートを辿っても行き場がありません。このような運用に近い参照情報は、DEPLOYMENT.mdに「外部連携」セクションを設けるか、専用の参照ドキュメント（REFERENCES.md）を追加することを検討します。ただし、文書を増やすとAIの参照コストが上がるため、まずは既存の7文書に収める努力をしましょう。

### 判断に迷いやすい典型例

実務で迷いやすい例をいくつか紹介します。

| 情報 | 迷うポイント | 推奨配置 | 理由 |
| ---- | ------------ | -------- | ---- |
| バリデーションルール | DOMAIN？ PATTERNS？ | DOMAIN | 「メールは一意」は業務ルール。「入力値チェックの書き方」はPATTERNS |
| エラーコード一覧 | DOMAIN？ PATTERNS？ | DOMAIN | エラーの種類と意味は業務に根ざす。コードの定数化方法はPATTERNS |
| 環境変数一覧 | ARCHITECTURE？ DEPLOYMENT？ | DEPLOYMENT | 本番・ステージング等の環境差異は運用の関心事 |
| ページネーション | ARCHITECTURE？ PATTERNS？ | PATTERNS | 実装のHow-Toに近い。ただし、上限値の根拠はDOMAIN |

迷ったときの最終判断基準は、「この情報が変わったとき、誰が気にするか」です。ビジネス側が気にするならPROJECT/DOMAIN、開発者が気にするならARCHITECTURE/PATTERNS、運用担当が気にするならDEPLOYMENTです。

---

## ケーススタディ

### ケース1：DB設計

「ユーザーテーブルのスキーマをどこに書く？」

**判断**：情報の性質によって分割します。

```markdown
## ARCHITECTURE.md に書くこと
- 使用するDB（PostgreSQL）
- テーブル間のリレーション概要
- インデックス戦略
- マイグレーション方針

## DOMAIN.md に書くこと
- User エンティティの属性と制約
- 状態遷移（active → suspended → deleted）
- ビジネスルール（メールは一意、など）
```

**理由**：
- 「PostgreSQLを使う」は技術的設計判断 → ARCHITECTURE
- 「メールは一意」はビジネスルール → DOMAIN

### ケース2：認証

「JWT認証の仕様をどこに書く？」

**判断**：

```markdown
## ARCHITECTURE.md に書くこと
- 認証方式（JWT）
- トークン署名アルゴリズム（RS256）
- トークン保存場所（Cookie/LocalStorage）
- リフレッシュトークンの保存先（Redis）

## DOMAIN.md に書くこと
- ログイン可能な条件（status=activeのみ）
- パスワードポリシー（12文字以上、等）
- ロックアウトルール（5回失敗で15分ロック）

## PATTERNS.md に書くこと
- 認証ミドルウェアの実装パターン
- トークン検証のコードパターン

## TESTING.md に書くこと
- 認証関連のテストケース一覧
- モック戦略（トークン生成のモック方法）
```

### ケース3：権限管理

「ロールベースアクセス制御をどこに書く？」

**判断**：

```markdown
## PROJECT.md に書くこと
- なぜ権限管理が必要か（ビジネス要件）
- 想定されるロール一覧（admin, member, viewer）

## DOMAIN.md に書くこと
- 各ロールの権限定義
- リソースとアクションのマトリクス
- 権限チェックのビジネスルール

## ARCHITECTURE.md に書くこと
- 権限チェックの実装場所（ミドルウェア? サービス?）
- 権限データの保存方法

## PATTERNS.md に書くこと
- 権限チェックのコードパターン
- デコレータ/ガード関数の使い方
```

### ケース4：監査ログ

「監査ログの要件をどこに書く？」

**判断**：

```markdown
## PROJECT.md に書くこと
- なぜ監査ログが必要か（コンプライアンス要件）
- 保存期間の要件

## DOMAIN.md に書くこと
- 記録すべきイベントの種類
- 各イベントの記録項目
- 個人情報のマスキングルール

## ARCHITECTURE.md に書くこと
- ログの保存先（CloudWatch, Elasticsearch等）
- ログの転送方式
- ログの構造化フォーマット

## DEPLOYMENT.md に書くこと
- ログの検索・閲覧方法
- アラート設定
- ログ保管・削除の運用手順
```

### ケース5：SLO（Service Level Objective）

「レスポンスタイム目標をどこに書く？」

**判断**：

```markdown
## PROJECT.md に書くこと
- ユーザー体験としての要件（「3秒以内に応答」）
- ビジネスインパクト（遅延による離脱率）

## TESTING.md に書くこと
- パフォーマンステストの閾値
- 負荷テストのシナリオ

## DEPLOYMENT.md に書くこと
- 具体的なSLO数値（p99 < 500ms）
- 監視設定とアラート閾値
- SLO違反時の対応手順
```

### 情報が複数文書にまたがるときの管理

ケーススタディを見てお気づきかもしれませんが、「認証」「権限」「監査ログ」といった横断的な機能は、複数の文書に情報が分散します。これをどう管理するかが実務上の課題です。

#### 代表文書を決める

まず、その機能の「代表文書」を決めます。認証であればARCHITECTURE.md、権限であればDOMAIN.mdが代表になることが多いでしょう。代表文書に「関連する記述は○○にもあります」という相互参照を入れておきます。

```markdown
## 認証（Authentication）

認証方式はJWTを採用します。

**関連情報**：
- ログイン可能条件・パスワードポリシー → DOMAIN.md#認証ルール
- 認証ミドルウェアの実装パターン → PATTERNS.md#認証
- テストのモック戦略 → TESTING.md#認証テスト
```

#### MASTER.mdにクロスリファレンスを集約する

複数の文書にまたがる情報は、MASTER.mdの索引セクションにクロスリファレンスとしてまとめておくと、AIが全体像を把握しやすくなります。

```markdown
## 横断的機能の参照先

| 機能 | PROJECT | ARCHITECTURE | DOMAIN | PATTERNS | TESTING | DEPLOYMENT |
| ---- | ------- | ------------ | ------ | -------- | ------- | ---------- |
| 認証 | - | ◎ | ○ | ○ | ○ | - |
| 権限 | ○ | ○ | ◎ | ○ | - | - |
| 監査ログ | ○ | ○ | ◎ | - | - | ○ |

◎: 代表文書　○: 関連情報あり
```

このマトリクスがあれば、「認証について知りたい」というときに、AIはARCHITECTURE.mdを中心に、関連するDOMAIN.md、PATTERNS.md、TESTING.mdも参照すべきだと判断できます。

---

## MASTER.mdの索引更新を必須タスクにする

### なぜ重要か

7文書に情報を追加しても、**MASTER.mdの索引が古いまま** だと、AIは新しい情報を見つけられません。

### ルール：文書変更時のチェックリスト

PRを出す前に、以下を確認します。

```markdown
## 文書変更時チェックリスト
- [ ] 追加した情報は適切な文書に配置されているか
- [ ] MASTER.md の文書索引が最新か
- [ ] MASTER.md のディレクトリ構造が最新か
- [ ] 関連する他の文書に矛盾がないか
```

### 自動化の例

CIで「MASTER.mdが更新されているか」をチェックします。

```yaml
# .github/workflows/docs-check.yml
name: Docs Check

on:
  pull_request:
    paths:
      - 'docs/**'

jobs:
  check-master-updated:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Check MASTER.md updated
        run: |
          # docs/配下が変更されている場合、MASTER.mdも変更されているか確認
          DOCS_CHANGED=$(git diff --name-only origin/${{ github.base_ref }} | grep '^docs/' | wc -l)
          MASTER_CHANGED=$(git diff --name-only origin/${{ github.base_ref }} | grep '^docs/MASTER.md' | wc -l)

          if [ "$DOCS_CHANGED" -gt 0 ] && [ "$MASTER_CHANGED" -eq 0 ]; then
            echo "::error::docs/ was changed but MASTER.md was not updated"
            echo "Please update MASTER.md to reflect the changes"
            exit 1
          fi
```

---

## AIに判断を任せる

### プロンプト例

新しい情報をどこに置くべきか、AIに判断を委ねることもできます。

```markdown
## 質問
以下の情報を7文書構成のどこに配置すべきか判断してください。

### 追加したい情報
[情報の内容]

### 判断基準
- PROJECT.md: ビジネス目標、ユーザー価値、要件
- ARCHITECTURE.md: 技術選定、システム構成、設計判断
- DOMAIN.md: ビジネスロジック、ルール、エンティティ
- PATTERNS.md: コーディング規約、実装パターン
- TESTING.md: テスト戦略、品質基準
- DEPLOYMENT.md: デプロイ、監視、運用

### 回答形式
1. 配置先の文書
2. 配置先のセクション（見出し）
3. 判断理由
4. 他の文書に関連情報を追加すべきか
```

### AIの判断例

```markdown
## 回答

### 追加情報：「APIレート制限を1分あたり100リクエストに設定」

1. **配置先の文書**: ARCHITECTURE.md
2. **配置先のセクション**: ## API設計 > ### レート制限
3. **判断理由**: レート制限の数値は技術的な設計判断であり、ビジネスルール（DOMAIN）ではないため
4. **関連情報**:
   - TESTING.md: レート制限のテストケースを追加
   - DEPLOYMENT.md: レート制限のモニタリング設定を追加
   - DOMAIN.md: レート制限に達した場合のユーザー向けメッセージを追加（該当する場合）
```

---

## 章末チェックリスト

- [ ] Decision Matrixを印刷またはブックマークする
- [ ] 最近追加した情報が適切な文書に配置されているか確認する
- [ ] MASTER.mdの索引が最新か確認する
- [ ] 「文書変更時チェックリスト」をPRテンプレートに追加する

---

## 次章への橋渡し

この章では、情報をどの文書に配置すべきかの判断基準を学びました。

次章では、**変更に強い運用**——影響度評価（changeImpact）を使って手戻りを最小化する方法を解説します。
