# セルフレビュー（PR作成前）

> **Parent**: [DEPLOYMENT.md](../DEPLOYMENT.md) | **Workflow Step**: 2.5 | **Related**: [自動コードレビュー](./automated-code-review.md)

## 目的

PRレビュー時の単純な指摘を事前に防ぎ、レビュー品質を向上させる。

PRを作成する前に、AIツールを活用して自己レビューを実施します。これにより、コーディング規約違反や単純なミスを事前に検出し、レビュワーの負担を軽減します。

---

## セルフレビューチェックリスト

### 1. コーディング規約の遵守

**チェック項目**:
- [ ] マジックナンバーが存在しないか
- [ ] 型安全性が確保されているか（any型の不適切な使用）
- [ ] エラーハンドリングが適切か
- [ ] 命名規則に従っているか
- [ ] 未使用のインポート/変数がないか

**AIツールへの指示例**:

```
MASTER.mdとPATTERNS.mdに基づいて、今回の変更をレビューしてください
```

---

### 2. 仕様との整合性確認

**チェック項目**:
- [ ] 要件定義通りに実装されているか
- [ ] アーキテクチャパターンに従っているか
- [ ] ビジネスロジックが仕様通りか
- [ ] セキュリティ要件を満たしているか

**AIツールへの指示例**:

```
今回の実装が、PROJECT.md、ARCHITECTURE.md、DOMAIN.mdの仕様と矛盾していないか確認してください
```

---

### 3. テストの充実度確認

**チェック項目**:
- [ ] 単体テストのカバレッジが80%以上
- [ ] エッジケースのテストが含まれているか
- [ ] エラーハンドリングのテストがあるか
- [ ] テストの可読性は十分か

**AIツールへの指示例**:

```
TESTING.mdの基準に照らし、テストが十分か評価してください
```

---

### 4. パフォーマンスとセキュリティの確認

**チェック項目**:
- [ ] N+1クエリ問題がないか
- [ ] 不要なループ処理がないか
- [ ] 入力値のサニタイゼーションが適切か
- [ ] SQLインジェクション/XSS対策が施されているか
- [ ] 機密情報のハードコーディングがないか

**AIツールへの指示例**:

```
パフォーマンスボトルネックやセキュリティ上の懸念点を指摘してください
```

---

### 5. ドキュメントの更新確認

**チェック項目**:
- [ ] README.mdの更新が必要か
- [ ] API仕様書の更新が必要か
- [ ] ARCHITECTURE.mdの更新が必要か
- [ ] 関連する技術文書の更新が必要か

**AIツールへの指示例**:

```
今回の変更で更新が必要なドキュメントを特定してください
```

---

## セルフレビューの実行方法（推奨）

### AIツールの対話的レビュー

**Claude Code / GitHub Copilot / Cursor での実行例**:

```
以下の観点で、今回のコミット内容をレビューしてください：

1. コーディング規約（docs/MASTER.md、docs/PATTERNS.md）
2. 仕様との整合性（docs/PROJECT.md、docs/ARCHITECTURE.md、docs/DOMAIN.md）
3. テスト充実度（docs/TESTING.md）
4. パフォーマンスとセキュリティ
5. ドキュメント更新の必要性

各観点について、問題点と改善提案を具体的に指摘してください。
問題がない場合は「問題なし」と明記してください。
```

AIがレビュー結果を返したら、指摘事項があればその場で修正します。

---

## その他の実行方法

### 自動化スクリプトの活用

`scripts/self-review.sh` を作成して実行:

```bash
./scripts/self-review.sh
```

**スクリプト内容（例）**:
- Linter実行（ESLint、Prettier等）
- 型チェック（TypeScript tsc --noEmit）
- テスト実行とカバレッジ計測
- セキュリティスキャン（npm audit、Snyk等）
- コミットメッセージ検証

### Git Hooksによる自動チェック

pre-push hookで自動実行（`.husky/pre-push`）することも可能です。

### Claude Code + Husky による自動レビュー（推奨）

コミット時に自動でAIレビューを実行するシステムを導入できます。
詳細は **[自動コードレビュー](./automated-code-review.md)** を参照してください。

**セットアップ**:

```bash
bash scripts/setup-automated-review.sh
```

**特徴**:
- `git commit` 時に自動でClaude Codeがレビュー
- Critical な問題があればコミットをブロック
- `/code-review` で手動レビューも可能
- 緊急時は `--no-verify` でスキップ可能

---

## セルフレビュー結果の記録

セルフレビューの結果をPR本文に含めることで、レビュワーに品質保証の証跡を提供します。

### 記録テンプレート

```markdown
## セルフレビュー結果

### 実施日時
2025-01-15 14:30

### チェック項目

#### 1. コーディング規約
- ✅ マジックナンバー: 問題なし（全て定数化済み）
- ✅ 型安全性: 問題なし（any型使用なし）
- ✅ エラーハンドリング: 問題なし（Result patternで統一）
- ✅ 命名規則: 問題なし（camelCase/PascalCase準拠）
- ✅ 未使用コード: 問題なし（Linterで検証済み）

#### 2. 仕様との整合性
- ✅ 要件定義: PROJECT.md#3.2の要件を全て実装
- ✅ アーキテクチャ: Clean Architectureに準拠
- ✅ ビジネスロジック: DOMAIN.mdの仕様通り
- ✅ セキュリティ: MASTER.md#セキュリティ要件を全て満たす

#### 3. テスト充実度
- ✅ カバレッジ: 85.3%（目標80%を達成）
- ✅ エッジケース: 境界値テスト実装済み
- ✅ エラーケース: 異常系テスト実装済み

#### 4. パフォーマンス・セキュリティ
- ✅ N+1クエリ: 問題なし（EagerLoadingで対応）
- ✅ 入力サニタイゼーション: 実装済み
- ✅ 認証・認可: JWT検証を実装
- ⚠️  注意: トークンリフレッシュのレート制限を実装予定（別Issue）

#### 5. ドキュメント更新
- ✅ README.md: 認証セクションを追加
- ✅ API仕様書: 新規エンドポイントを記載
- ✅ ARCHITECTURE.md: 認証フローの図を追加

### 結論
すべての必須項目をクリアしています。PR作成準備完了。
```

---

## ベストプラクティス

### 1. レビューは小さい単位で頻繁に実施
- コミット毎にセルフレビューを行う
- 大きな変更は複数のコミットに分割

### 2. AIツールを積極的に活用
- Claude Code、GitHub Copilot等に明示的にレビューを依頼
- 指摘事項は即座に修正

### 3. チェックリストを毎回確認
- 形式的にならないよう、実質的な確認を心がける
- 新しい観点があれば随時追加

### 4. 指摘事項は全て記録
- 修正した問題点を記録することで、今後の学習に繋げる
- ナレッジベースへの蓄積材料とする

### 5. 時間をかけすぎない
- セルフレビューは15-30分程度で完了させる
- 深刻な問題のみ修正し、細かい改善は別Issueで対応

---

## セルフレビュー後のアクション

### 問題が見つかった場合

修正してコミット:

```bash
git add .
git commit -m "fix: セルフレビュー指摘事項を修正

- マジックナンバーを定数化
- エラーハンドリングを改善
- テストケースを追加

参照: docs/PATTERNS.md:87"
```

### 問題がない場合

次ステップ（PR作成）へ進む。
