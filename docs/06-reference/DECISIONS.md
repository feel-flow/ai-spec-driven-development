# DECISIONS.md - アーキテクチャ決定記録（ADR）

## ADR-001: マイクロサービスアーキテクチャの採用

### ステータス
承認済み

### コンテキスト
システムの拡張性と開発チームの独立性を確保する必要がある。複数のチームが並行して開発を進め、サービスごとに異なる技術スタックを選択できる柔軟性が求められている。

### 決定
マイクロサービスアーキテクチャを採用する。各サービスは独立してデプロイ可能とし、APIゲートウェイを通じて通信する。

### 理由
- **スケーラビリティ**: サービスごとに独立したスケーリングが可能
- **技術選択の自由**: 各サービスで最適な技術スタックを選択可能
- **障害の分離**: 一つのサービスの障害が全体に波及しない
- **開発速度**: チーム間の依存を最小化し、並行開発が可能

### 影響
- **ポジティブ**: 
  - 高い拡張性と可用性
  - チームの自律性向上
  - 技術的負債の局所化
- **ネガティブ**:
  - 運用の複雑性増大
  - ネットワーク遅延の考慮が必要
  - 分散トランザクション管理の複雑化

### 代替案
- モノリシックアーキテクチャ: シンプルだが拡張性に限界
- モジュラーモノリス: 中間的な選択肢だが、最終的な分離が困難

---

## ADR-002: PostgreSQLをメインデータベースとして選択

### ステータス
承認済み

### コンテキスト
信頼性が高く、複雑なクエリに対応でき、JSONデータも扱えるデータベースが必要。

### 決定
PostgreSQL 14を採用する。

### 理由
- **ACID準拠**: トランザクションの信頼性
- **JSON対応**: 構造化/非構造化データの両方を扱える
- **拡張性**: パーティショニング、レプリケーション対応
- **コミュニティ**: 活発なコミュニティと豊富なドキュメント

### 影響
- **ポジティブ**:
  - 高い信頼性とデータ整合性
  - 複雑なクエリの効率的な処理
  - 将来の拡張が容易
- **ネガティブ**:
  - 水平スケーリングに制限
  - 大規模データでのパフォーマンスチューニングが必要

---

## ADR-003: TypeScriptの全面採用

### ステータス
承認済み

### コンテキスト
大規模なコードベースで型安全性を確保し、開発効率を向上させたい。

### 決定
フロントエンド・バックエンド共にTypeScriptを採用する。

### 理由
- **型安全性**: コンパイル時のエラー検出
- **IDE支援**: 優れた自動補完とリファクタリング
- **コード品質**: 明示的な型定義による可読性向上
- **エコシステム**: 豊富な型定義ライブラリ

### 影響
- **ポジティブ**:
  - バグの早期発見
  - リファクタリングの安全性
  - ドキュメント性の向上
- **ネガティブ**:
  - 初期学習コスト
  - ビルド時間の増加

---

## ADR-004: イベント駆動アーキテクチャの部分採用

### ステータス
承認済み

### コンテキスト
サービス間の疎結合を実現し、非同期処理を効率的に行いたい。

### 決定
重要なビジネスイベントに対してイベント駆動アーキテクチャを採用。Apache Kafkaをメッセージブローカーとして使用。

### 理由
- **疎結合**: サービス間の直接的な依存を削減
- **スケーラビリティ**: 非同期処理による高いスループット
- **イベントソーシング**: 監査ログとして活用可能
- **リアルタイム処理**: ストリーム処理が可能

### 影響
- **ポジティブ**:
  - サービスの独立性向上
  - 高いスループット
  - イベント履歴の保持
- **ネガティブ**:
  - 結果整合性の管理
  - デバッグの複雑化
  - インフラコストの増加

---

## ADR-005: Kubernetesによるコンテナオーケストレーション

### ステータス
承認済み

### コンテキスト
コンテナ化されたアプリケーションの管理、スケーリング、デプロイメントを自動化したい。

### 決定
Kubernetes（EKS）を採用する。

### 理由
- **自動スケーリング**: 負荷に応じた自動スケール
- **自己修復**: 障害時の自動復旧
- **宣言的設定**: Infrastructure as Code
- **エコシステム**: 豊富なツールとの統合

### 影響
- **ポジティブ**:
  - 高可用性の実現
  - デプロイメントの自動化
  - リソースの効率的な利用
- **ネガティブ**:
  - 学習曲線が急
  - 運用の複雑性
  - 初期設定コスト

---

## ADR-006: GraphQL APIの採用

### ステータス
検討中

### コンテキスト
クライアントが必要なデータのみを効率的に取得できるAPIが必要。

### 決定案
パブリックAPIにGraphQLを採用する。

### 理由
- **効率的なデータ取得**: オーバーフェッチ/アンダーフェッチの解消
- **型安全性**: スキーマによる型定義
- **開発者体験**: 優れたツールとドキュメント
- **バージョニング不要**: フィールドの追加/廃止が容易

### 懸念事項
- **複雑性**: N+1問題の対処
- **キャッシング**: HTTPキャッシュの活用が困難
- **学習コスト**: 新しいパラダイムの習得

---

## ADR-007: Zero Trust Securityモデル

### ステータス
承認済み

### コンテキスト
従来の境界防御では不十分で、内部ネットワークでも信頼しないセキュリティモデルが必要。

### 決定
Zero Trustセキュリティモデルを採用する。

### 実装内容
- すべての通信を暗号化（mTLS）
- サービス間の認証・認可（Service Mesh）
- 最小権限の原則
- 継続的な検証

### 影響
- **ポジティブ**:
  - セキュリティの大幅な向上
  - 内部脅威への対応
  - コンプライアンス要件の充足
- **ネガティブ**:
  - 実装の複雑性
  - パフォーマンスオーバーヘッド
  - 運用コストの増加

---

## ADR-008: モノレポ vs ポリレポ

### ステータス
承認済み

### コンテキスト
複数のサービスとライブラリを効率的に管理する必要がある。

### 決定
モノレポ（Monorepo）を採用し、Nx/Rushを使用する。

### 理由
- **コード共有**: 共通コードの再利用が容易
- **原子的変更**: 複数サービスへの変更を一度にコミット
- **依存関係管理**: バージョン不整合の防止
- **ツールの統一**: リント、テスト、ビルドツールの共有

### 影響
- **ポジティブ**:
  - 開発効率の向上
  - 一貫性の確保
  - リファクタリングの容易さ
- **ネガティブ**:
  - リポジトリサイズの増大
  - CI/CD時間の増加
  - Git操作の複雑化

---

## ADR-009: 認証・認可の実装方針

### ステータス
承認済み

### コンテキスト
セキュアで拡張可能な認証・認可システムが必要。

### 決定
- 認証: OAuth 2.0 / OpenID Connect
- 認可: Policy-Based Access Control (PBAC)
- 実装: Keycloak + Open Policy Agent (OPA)

### 理由
- **標準準拠**: 業界標準プロトコル
- **柔軟性**: 複雑な認可ルールに対応
- **分離**: 認証と認可の関心の分離
- **監査**: 詳細なアクセスログ

### 影響
- **ポジティブ**:
  - 高いセキュリティ
  - 柔軟な権限管理
  - シングルサインオン
- **ネガティブ**:
  - 初期設定の複雑さ
  - 追加のインフラコンポーネント

---

## ADR-010: 監視・可観測性スタック

### ステータス
承認済み

### コンテキスト
分散システムの問題を迅速に検出・診断できる監視システムが必要。

### 決定
- メトリクス: Prometheus + Grafana
- ログ: ELK Stack (Elasticsearch, Logstash, Kibana)
- トレーシング: Jaeger
- APM: Datadog

### 理由
- **包括的な可視性**: メトリクス、ログ、トレースの統合
- **問題の早期発見**: プロアクティブな監視
- **根本原因分析**: 詳細なトレーシング
- **実績**: 業界での広い採用実績

### 影響
- **ポジティブ**:
  - 問題の迅速な解決
  - パフォーマンスの最適化
  - SLO/SLAの管理
- **ネガティブ**:
  - 運用コスト
  - データストレージ要件
  - 複数ツールの管理

---

## 決定記録テンプレート

```markdown
## ADR-XXX: [タイトル]

### ステータス
[提案中/検討中/承認済み/廃止/置換済み]

### コンテキスト
[決定が必要な背景と問題を記述]

### 決定
[実際の決定内容を記述]

### 理由
[この決定を選んだ理由を箇条書きで]

### 影響
- **ポジティブ**:
  - [良い影響1]
  - [良い影響2]
- **ネガティブ**:
  - [悪い影響1]
  - [悪い影響2]

### 代替案
[検討した他の選択肢と却下理由]

### 関連
- [関連するADR]
- [参考資料へのリンク]
```

---

## 決定ログ

| ADR番号 | タイトル | 決定日 | ステータス | 決定者 |
|---|---|---|---|---|
| ADR-001 | マイクロサービスアーキテクチャ | 2024-01-15 | 承認済み | アーキテクトチーム |
| ADR-002 | PostgreSQL採用 | 2024-01-20 | 承認済み | テックリード |
| ADR-003 | TypeScript採用 | 2024-01-22 | 承認済み | 開発チーム |
| ADR-004 | イベント駆動アーキテクチャ | 2024-02-01 | 承認済み | アーキテクトチーム |
| ADR-005 | Kubernetes採用 | 2024-02-10 | 承認済み | インフラチーム |
| ADR-006 | GraphQL API | 2024-02-15 | 検討中 | APIチーム |
| ADR-007 | Zero Trust Security | 2024-02-20 | 承認済み | セキュリティチーム |
| ADR-008 | モノレポ採用 | 2024-03-01 | 承認済み | 開発チーム |
| ADR-009 | 認証・認可方針 | 2024-03-10 | 承認済み | セキュリティチーム |
| ADR-010 | 監視スタック | 2024-03-15 | 承認済み | SREチーム |
| ADR-011 | ドキュメント構造再構築 (ai_spec_driven_development.md v2.0.0) | 2025-10-16 | 承認済み | Docsガバナンスチーム |

---

## ADR-011: ドキュメント構造再構築 (ai_spec_driven_development.md v2.0.0)

### ステータス
承認済み

### コンテキスト
既存の `ai_spec_driven_development.md` は 2000 行超の長文ナラティブ形式で、AIエージェントによる要点抽出に時間がかかり、検索性・差分追跡性が低下していた。Doc更新時の衝突(巨大ファイル再生成)や部分的パッチ適用の困難さが品質低下とレビュー負荷増を引き起こしていた。

### 問題
- 構造化セクション不足により意図/ルール/手順/変更履歴が混在
- 変更差分レビュー時に重要度判定が困難 (インパクトの粒度なし)
- AIエージェントが再生成時に不要な歴史的説明を再出力し冗長化
- 文書間参照が非正規化 (MASTER.md とのルール重複)

### 決定
`ai_spec_driven_development.md` を運用仕様書形式へ再構築し、以下を採用:
- フロントマター標準化 (id, version, status, phase, changeImpact 等)
- セクション分割 (目的/ワークフロー/分類マトリクス/更新ポリシー/エージェントチェックリスト)
- 変更インパクトレベル (LOW/MEDIUM/HIGH) の導入
- MUST コマンド/バリデーション手順の明文化
- 冗長ナラティブ削除 + Revision History テーブル簡潔化

### 理由
- 可読性/検索性向上 (スキャン時間短縮)
- 差分と影響範囲の明確化 (レビュープロセス効率化)
- AIエージェント操作の決定的手順化 (初期化→分類→更新→確定)
- ドキュメントの最小責務化 (重複排除し参照一貫性)
- メジャー変更を SemVer に反映し追跡性向上

### 影響
- **ポジティブ**:
  - 初期 AI 解析コスト削減 (推定 ~60%)
  - 衝突リスク減少 (局所パッチ適用性向上)
  - レビュー時間短縮 (インパクトラベルによる優先度付け)
  - セキュリティ/ミス防止チェックリストの強化
  - 後続自動検証ツール導入容易化
- **ネガティブ**:
  - 既存リンク更新作業が必要
  - メジャーバージョンアップに伴う一時的なコンテキスト再学習コスト
  - 新ルール (インパクト分類) のチーム教育が必要

### 代替案
- 部分的リファクタのみ: 冗長性と構造問題が根本解決されないため却下
- 別ファイルへ分割 (複数ファイル化): 初期探索コストが逆に増加する懸念で却下

### 関連
- CHANGELOG v2.0.0 エントリ
- MASTER.md (全体ルール) / ARCHITECTURE.md / DOMAIN.md
- LESSONS_LEARNED.md (再構築後の学び追記予定)

### 実行後フォローアップ
- PRテンプレートへ Impact Level チェックボックス追加 (未着手)
- VALIDATION.md へドキュメント構造検証手順統合 (計画中)
